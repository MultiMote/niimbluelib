import { EncodedImage } from '../image_encoder'
import { PacketGenerator } from '../packets'
import { AbstractPrintTask } from './AbstractPrintTask'

/**
 * @category Print tasks
 */
export class OldD11PrintTask extends AbstractPrintTask {
  override printInit(): Promise<void> {
    return this.abstraction.sendAll([
      PacketGenerator.setDensity(this.printOptions.density),
      PacketGenerator.setLabelType(this.printOptions.labelType),
      PacketGenerator.printStart(),
    ])
  }

  override printPage(image: EncodedImage, quantity: number): Promise<void> {
    this.checkAddPage(quantity ?? 1)

    return this.abstraction.sendAll(
      [
        PacketGenerator.printClear(),
        PacketGenerator.pageStart(),
        PacketGenerator.setPageSizeV1(image.rows),
        PacketGenerator.setPrintQuantity(quantity ?? 1),
        ...PacketGenerator.writeImageData(image, {
          printheadPixels: this.printheadPixels(),
        }),
        PacketGenerator.pageEnd(),
      ],
      this.printOptions.pageTimeoutMs,
    )
  }

  override waitForFinished(page: number): Promise<boolean> {
    return this.abstraction.waitUntilPrintFinishedByPageIndex(page, this.printOptions.statusTimeoutMs)
  }
}
